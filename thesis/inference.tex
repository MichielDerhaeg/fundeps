\section{Inference and Elaboration}

\subsection{Source Syntax}
\begin{figure}[h]
\begin{align*}
    a, b &::= \; \langle type \; variable \rangle \\
    x, f &::= \; \langle term \; variable \rangle \\
    T    &::= \; \langle type \; constructor \rangle \\
    K    &::= \; \langle data \; constructor \rangle \\
    TC   &::= \; \langle class \; constructor \rangle \\
    \\
    pgm &::= \overline{decl} &program\\
    decl &::= cls \mid inst \mid data \mid val &declaration\\
    cls &::= \textbf{class} \; \forall \overline{a} \overline{b}. \overline{\pi}
    \Rightarrow TC \mid \overline{fd}^m \textbf{where} \; f :: \sigma &class\\
    inst &::= \textbf{instance} \; \forall \overline{a} \overline{b}.
    \overline{\pi} \Rightarrow TC \; \overline{u} \; \textbf{where} \; f = e
    &instance\\
    data &::= \textbf{data} \; T \; \overline{a} = \overline{K \; \overline{a}
    \;} &data\\
    val &::= x = e \mid x :: \sigma = e &value \; binding\\
    fd &::= a_1 \mathellipsis a_n \rightarrow a_0 &fundep\\
    \\
    e &::= x \mid K \mid e_1 \; e_2 \mid \lambda x. e \mid \textbf{let} \; x =
    e_2 \; \textbf{in} \; e_2 \\
    &\quad \mid \textbf{case} \; e_{scr} \; \textbf{of} \; \overline{K \; \overline{x}
    \rightarrow e} &term \\
    \\
    \sigma &::= \rho \mid \forall a. \sigma &polytype \\
    \rho &::= \tau \mid Q \Rightarrow \rho &qualified \; type \\
    \tau &::= a \mid T \mid \tau_1 \; \tau_2 \mid F(\overline{\tau})
         &monotype \\
    u &::= a \mid T \mid u_1 \; u_2 &type \; pattern \\
    \\
    \phi &::= \tau_1 \sim \tau_2 &equality \; constraint \\
    \pi &::= TC \; \overline{\tau} &class \; constraint \\
    \\
    S &::= \forall \overline{a}. \overline{\pi} \Rightarrow \pi &constraint \;
    scheme
\end{align*}
%TODO put scheme and equality constraint with inference syntax?
\caption{Source syntax}
\label{source-syntax}
\end{figure}

\include{infer-fundeps}

\subsection{Constraint Generation}
\begin{figure}[h]
% TmVar
% TODO fix and define P and E
% TODO include \notin dom
$$
\inferrule*[right=TmVar]
{
    (x : \forall \overline{a} \overline{b}. \overline{\pi} \Rightarrow \tau) \in
    \Gamma
    \\
    \overline{\alpha},\overline{d} \; \text{fresh}
    \\
    \theta = [ \overline{\alpha} \mapsto \overline{a}] \; \cdot \; det(\overline{\pi},
    \overline{a})
}
{
    \Gamma \vdash_{tm} x : \theta(\tau) \rightsquigarrow x \; \overline{\alpha}
    \; \theta(\overline{b}) \; \overline{d} \; | \; \overline{d : \theta(\pi)}; \bullet
}
$$
% TmAbs
$$
\inferrule*[right=TmAbs]
{
    \Gamma, x : \alpha \vdash_{tm} e : \tau \rightsquigarrow t \; | \; P ; E
    \\
    \alpha \; \text{fresh}
}
{
    \Gamma \vdash_{tm} \lambda x. e : ( \alpha \rightarrow \tau) \rightsquigarrow
    \lambda (x : \alpha) . t \; | \; P ; E
}
$$
% TmApp
$$
\inferrule*[right=TmApp]
{
    \Gamma \vdash_{tm} e_1 : \tau_1 \; | \; P_1; E_1
    \\
    \Gamma \vdash_{tm} e_2 : \tau_2 \; | \; P_2; E_2
    \\
    \alpha, c \; \text{fresh}
    \\
    P = P_1, P_2
    \\
    E = E_1, E_2, c : \tau_1 \sim (\tau_1 \rightarrow \alpha)
}
{
    \Gamma \vdash_{tm} e_1 \; e_2 : a \rightsquigarrow (t_1 \triangleright c) \; t_2
    \; | \; P ; E
}
$$
% TmLet
$$
\inferrule*[right=TmLet]
{
    \Gamma, x : \alpha \vdash_{tm} e_1: \tau_1 \rightsquigarrow t_1 \; | \;
    P_1; E_1
    \\
    \Gamma, x : \alpha \vdash_{tm} e_2: \tau_2 \rightsquigarrow t_2 \; | \;
    P_2; E_2
    \\
    \alpha, c \; \text{fresh}
    \\
    P = P_1, P_2
    \\
    E = E_1, E_2, c : \alpha \sim \tau_1
}
{
    \Gamma \vdash_{tm} (\textbf{let} \; x = e_1 \; \textbf{in} \; e_2) : \tau_2
    \rightsquigarrow (\textbf{let} \; x : \tau_1 = t_1 \; \textbf{in} \; t_2) \;
    | \; P ; E
}
$$
% TmCon
$$
\inferrule*[right=TmCon]
{
    (K : \forall \overline{a} . \tau) \in \Gamma
    \\
    \overline{\beta} \; \text{fresh}
}
{
    \Gamma \vdash_{tm} K : [ \overline{\alpha \mapsto \beta}] \tau
    \rightsquigarrow K \; \overline{\beta} \; | \; \bullet ; \bullet
}
$$
% TmCase
$$
\inferrule*[right=TmCase]
{
    \Gamma \vdash_{tm} e_{scr} : \tau_{scr} \rightsquigarrow t_{scr} \mid P_{scr}; E_{scr}
    \\
    \alpha, \overline{\beta}, c, \overline{c'} \; \text{fresh}
    \\
    (K_i : \forall \overline{a}. \overline{\tau}^i \rightarrow T \; \overline{a})
    \in \Gamma
    \\
    \Gamma, \overline{x_i : [\overline{a \mapsto \beta}]\tau_{e_i}} \vdash_{tm} e_i
    : \tau_{e_i} \rightsquigarrow t_{e_i} \mid P_{e_i}; E_{e_i}
}
{
    \Gamma \vdash_{tm} \textbf{case} \; e_{scr} \; \textbf{of} \; \overline{K \;
    \overline{x} \rightarrow e} : \alpha \rightsquigarrow \textbf{case} \;
    t_{scr} \triangleright c \; \textbf{of} \; \overline{K \; \overline{x} \rightarrow t
    \triangleright c'} \\
    \mid P_{scr}, \overline{P_e}; E_{scr}, \overline{E_e}, c : \tau_{scr} \sim T
    \; \overline{\beta}, \overline{c' : \tau_e \sim \alpha}
}
$$
\caption{Term Elaboration and Constraint Generation}
\end{figure}

\begin{figure}
$$
\mathbb{E} ::= \square \mid \textbf{case} \; d \; \textbf{of} \; K \;
\overline{a} \rightarrow \mathbb{E}
$$
\begin{mathpar}
\inferrule*[right=Hole]
{
}
{
    \Gamma \vdash_{\mathbb{E}} \bullet \rightsquigarrow \square \mid \bullet
    \mid \Gamma
}
% TODO kind b'
\inferrule*[right=MCtx]
{
    \textbf{class} \; \forall \overline{a} \overline{b}. \overline{\pi}
    \Rightarrow TC \; \overline{a} \mid \overline{fd} \; \textbf{where} \; f ::
    \sigma
    \\
    fd_i \equiv \overline{a}^{i_n} \rightarrow a_{i_0}
    \\
    \overline{d}, \overline{c}, \overline{b'}, f' \; \text{fresh}
    \\
    \overline{\Gamma \vdash_{cc} \pi \rightsquigarrow \tau}
    \\
    \Gamma \vdash_{ty} \sigma \rightsquigarrow v
    \\
    \phi_i = F_{TC_i}(\overline{a}^{i_n}) \sim a_{i_0}
    \\
    \overline{\Gamma \vdash_{eq} \phi \rightsquigarrow \psi}
    \\
    \theta = [ \overline{a} \mapsto \overline{u}, \overline{b} \mapsto
    \overline{b'}]
    \\
    \Gamma,f': \theta(\sigma), \overline{b'} \vdash_{\mathbb{E}} \overline{d : \theta(\pi)}, \mathcal{P}
    \rightsquigarrow \mathbb{E}' \mid \mathcal{C}_g' \mid \Gamma'
    \\
    \mathbb{E} = \textbf{case} \; d \; \textbf{of} \; K_{TC} \; \overline{b'} \;
    (\overline{c : \theta(\psi)}) \; (\overline{d : \theta(\tau)}) \; (f' :
    \theta(v)) \rightarrow \mathbb{E}'
}
{
    \Gamma \vdash_{\mathbb{E}} (d : TC \; \overline{u}),\mathcal{P}
    \rightsquigarrow \mathbb{E} \mid \overline{c : \theta(\phi)}, \overline{d :
    \theta(\pi)}, \mathcal{C}_g' \mid \Gamma'
}
\end{mathpar}
\caption{Match Contexts}
\end{figure}

\begin{figure}
\begin{mathpar}
% TODO kinds
% TODO too huge
\inferrule*[right=Class]
{
    unambig(\overline{b}, \overline{a}, \overline{\pi}) % TODO conditions seperately?
    \\
    \overline{c}, \overline{d}, x \; \text{fresh}
    \\
    \Gamma, \overline{a} \vdash_{ty} \sigma \rightsquigarrow v
    \\
    \overline{\Gamma, \overline{a}, \overline{b} \vdash_{cc} \pi
    \rightsquigarrow \tau}
    \\
    fd_i \equiv \overline{a}^{i_n} \rightarrow a_{i_0}
    \\
    \psi_i = F_{TC_i}(\overline{a}^{i_n}) \sim a_{i_0}
    \\
    \sigma \equiv \forall \overline{a'}. \overline{\pi'} \Rightarrow \tau'
    \\
    \sigma_{real} = \forall \overline{a} \overline{a'}. \; TC \; \overline{a} \Rightarrow
    \overline{\pi'} \Rightarrow \tau'
    \\
    \Gamma \vdash_{ty} \sigma_{real} \rightsquigarrow v_{real}
    \\
    t_f = \Lambda \overline{a} \overline{a'}. \lambda(d : T_{TC} \; \overline{a}). \textbf{case}
    \; d \; \textbf{of} \; K_{TC} \; \overline{b} \; (\overline{c : \psi}) \;
    (\overline{d : \pi}) \; (x : v) \rightarrow x \; \overline{a'}
    \\
    \overline{decl_c} =
    [\textbf{data} \; T_{TC} \; \overline{a} \;
    \textbf{where} \lbrace K_{TC} \colon \forall \overline{a} \overline{b}. \;
    \overline{\psi} \Rightarrow \overline{\tau} \rightarrow v \rightarrow T_{TC}
    \; \overline{a} \rbrace
    , \overline{\textbf{type} \, F_{TC_i} \; \overline{a}^{i_n}}^m
    , \textbf{let} \; f : v_{real} = t_f
    ]
}
{
    \Gamma \vdash_{cls} \textbf{class} \; \forall \overline{a} \overline{b} .
    \overline{\pi} \rightarrow TC \; \overline{a} \mid \overline{fd}^m
    \textbf{where} \; f :: \sigma \rightsquigarrow \overline{decl_c} \mid [ f :
    \sigma_{real} ]
}
\end{mathpar}
\caption{Class Elaboration}
\end{figure}

\begin{figure}
\begin{mathpar}
\inferrule*[right=Instance]
{
    d_I, \overline{d} \; \text{fresh}
    \\
    \Gamma \vdash_{\mathbb{E}} (\overline{d : \pi}) \rightsquigarrow \mathbb{E}
    \mid P_{\mathbb{E}} \mid \Gamma_{\mathbb{E}}
    \\
    P_I = P, P_{ax}, \overline{d : \pi}, P_{\mathbb{E}}
    \\
    \Gamma_I = \Gamma_{\mathbb{E}}, \overline{a}, \overline{b}
    \\
    S_I = \forall \overline{a} \overline{b}. \; \overline{\pi} \Rightarrow TC \;
    \overline{u}
    \\
    \overline{\Gamma, \overline{a}, \overline{b} \vdash_{cc} \pi
    \rightsquigarrow \tau}
    \\
    (f : \forall \overline{a'} \overline{b'}. \; TC \; \overline{a'}
    \Rightarrow \overline{\pi'} \Rightarrow \tau) \in \Gamma
    \\
    P_I, d_I : S_I; \Gamma_I \vdash_{tm} e : [\overline{a'} \mapsto
    \overline{u}] (\forall \overline{b'}. \; \overline{\pi'} \Rightarrow \tau)
    \rightsquigarrow t
    \\
    S_I \hookrightarrow P_{ax}
    \\
    P_I \vdash_{sc} TC \; \overline{u} \rightsquigarrow
    (\overline{\tau_b}, \overline{\gamma_c}, \overline{t_d})
}
{
    P; \Gamma \vdash_{inst} \textbf{instance} \; \forall \overline{a}
    \overline{b}. \overline{\pi} \Rightarrow TC \; \overline{u} \;
    \textbf{where} \; f = e \\
    \rightsquigarrow [ \overline{\textbf{axiom} \; P_{ax}} , d_I :: \forall
    \overline{a} \overline{b}. \;  \overline{\tau} \rightarrow T_{TC} \;
    \overline {u} = \Lambda \overline{a} \overline{b}. \; \lambda\overline{(d :
    \tau)}. \; \mathbb{E}[K_{TC} \; \overline{u} \; \overline{\tau}_b \;
    \overline{\gamma}_c \; \overline{t}_d \; t]] \mid [P_{ax}, d_I : S_I]
}
\end{mathpar}
\caption{Instance Elaboration}
\end{figure}

\begin{figure}
\begin{mathpar}
\inferrule*[right=SC]
{
    \textbf{class} \; \forall \overline{a} \overline{b} \Rightarrow TC \;
    \overline{a} \mid \overline{fd}^m
    \\
    \overline{c}, \overline{d} \; \text{fresh}
    \\
    \theta = [\overline{a} \mapsto \overline{u}] \cdot det(\overline{a},
    \overline{\pi})
    \\
    P_{int} \vdash_{E} (\overline{d : \theta(\pi)}), (\overline{c :
    \theta(F_{TC_i}(\overline{a}^{i_n}) \sim a_{i_0})}) \rightsquigarrow
    \bullet, \theta_s, \eta_s
}
{
    P_{int} \vdash_{SC} (TC \; \overline{u}) \rightsquigarrow
    (\theta_s(\theta(\overline{b})), \eta_s(\overline{c}), \eta_s(\overline{d}))
}
\end{mathpar}
\caption{Superclass Entailment}
\end{figure}

\begin{figure}
% TODO mention or put in rule how to get instatiated fundep types
\begin{mathpar}
\inferrule*[right=AxiomGen]
{
    (fd_i \equiv \overline{a}^{i_n} \rightarrow a_{i_0}) \in (\overline{fd}^m
    \in TC)
    \\
    \overline{g} \; \text{fresh}
    \\
    \theta_i = det(fv(\overline{u}^{i_n}), \overline{\pi})
    \\
    fv(\theta_i(u_{i_0})) \subseteq fv(\overline{u}^{i_n})
}
{
    (\forall \overline{a} \overline{b}. \; \overline{\pi} \Rightarrow TC \;
    \overline{u}) \hookrightarrow \overline{g_i(fv(\overline{u}^{i_n})) :
    F_{TC_i}(\overline{u}^{i_n}) \sim \theta_i(u_{i_0})}^m
}
\end{mathpar}
\caption{Axiom Generation}
\end{figure}
